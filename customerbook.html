<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ãŠå®¢ã•ã‚“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¸³</title>
	<link rel="icon" href="ã‚¢ã‚¤ã‚³ãƒ³.png" type="image/png">
	<link rel="stylesheet" href="assets/common.css">
	<link rel="stylesheet" href="assets/customerbook.css">
</head>

<body>
	<div class="app-shell">

		<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
		<div class="header-card">
			<div class="header-title">ãŠå®¢ã•ã‚“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¸³</div>
			<div class="cast-pill">
				<div class="cast-pill-inner">
					<span id="castName">[ãªã¾ãˆ]ã®ãƒšãƒ¼ã‚¸</span>ğŸ’Ÿ
				</div>
			</div>
		</div>

		<!-- â–¼ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼šå…¨å“¡åˆ†ã®æ¥åº—ãƒ­ã‚°ã–ã£ãã‚Š -->
		<div class="calendar-card">
			<div class="calendar-header">
				<button class="cal-nav" id="calPrevBtn">â—€</button>
				<div class="calendar-title" id="calTitle">2025å¹´1æœˆ</div>
				<button class="cal-nav" id="calNextBtn">â–¶</button>
			</div>
			<div class="calendar-grid" id="calendarGrid">
				<!-- JSã§æ›œæ—¥ï¼†ãƒã‚¹ã‚’ç”Ÿæˆ -->
			</div>
			<div id="visitDetailBox"></div>
		</div>


		<!-- ä¸€è¦§ã‚«ãƒ¼ãƒ‰ -->
		<div class="list-card">
			<div class="list-headline">
				<!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼‹äººæ•°ãƒãƒƒã‚¸ -->
				<div class="list-title-group">
					<div class="list-title">ğŸ“’ ãŠå®¢ã•ã‚“ãƒªã‚¹ãƒˆ</div>
					<div class="list-count" id="customerCount">å…¨0äºº</div>
				</div>
				<div class="list-actions">
					<button class="add-btn" id="addCustomerBtn">NEWï¼‹</button>
					<button class="log-btn" id="logTodayBtn">ä»Šæ—¥ã®æ¥åº—ãƒ­ã‚°</button>
				</div>

				<!-- ä¸¦ã³é †ï¼‹æ¤œç´¢ï¼‹è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆãªã‚ã‚‰ã‹ç®±ï¼‰ -->
				<div class="list-tools">
					<!-- ä¸¦ã³æ›¿ãˆ -->
					<div class="list-sort">
						<select id="sortMode">
							<option value="rank">æ¨ã•ã‚Œãƒ©ãƒ³ã‚¯é †</option>
							<option value="last">æœ€çµ‚æ¥åº—ãŒæ–°ã—ã„é †</option>
							<option value="name">åå‰é †</option>
						</select>
					</div>

					<!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
					<div class="list-search">
						<input
							id="searchKeyword"
							type="text"
							placeholder="åå‰ãƒ»ãƒ¡ãƒ¢ã§æ¤œç´¢"
						/>
						<button id="searchBtn" type="button">æ¤œç´¢</button>
					</div>
				</div>
			</div>

			<div class="cust-list" id="customerList">
				<!-- JSã§ãƒªã‚¹ãƒˆè¡¨ç¤º -->
			</div>
		</div>

		<!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
		<div class="edit-card">
			<div class="edit-title-row">
				<div>ğŸ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</div>
				<div class="edit-hint" id="editHint">
					æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
				</div>
			</div>

			<!-- A. åŸºæœ¬ / é–¢ä¿‚æ€§ -->
			<div class="field-block">
				<label>åå‰ï¼ˆå‘¼ã³åï¼‰</label>
				<input type="text" id="f_display_name" placeholder="å…¬èªã‚ã åã¨éå…¬èªã‚ã åæ°—ã‚’ä»˜ã‘ã¦ã­ï¼" />
			</div>

			<div class="field-block">
				<label>æ¨ã•ã‚Œãƒ©ãƒ³ã‚¯ ğŸ’–ï¼ˆ0ã€œ5ï¼‰</label>
				<div class="osare-select-row">
					<div class="osare-hearts-picker" id="osarePicker">
						<div class="osare-heart-btn" data-level="0">ğŸ¤</div>
						<div class="osare-heart-btn" data-level="1">ğŸ’™</div>
						<div class="osare-heart-btn" data-level="2">ğŸ’š</div>
						<div class="osare-heart-btn" data-level="3">ğŸ’›</div>
						<div class="osare-heart-btn" data-level="4">ğŸ§¡</div>
						<div class="osare-heart-btn" data-level="5">ğŸ’—</div>
					</div>
					<div style="font-size:.8rem;font-weight:600;">
						<span id="osareLevelText">0</span> /5
					</div>
				</div>
			</div>

			<div class="field-block">
				<label>é€£çµ¡å…ˆäº¤æ›æ¸ˆã¿ï¼Ÿ</label>
				<div class="contact-row">
					<input type="checkbox" id="f_has_contact" class="contact-toggle" />
					<div>äº¤æ›æ¸ˆğŸ’¬</div>
				</div>
			</div>

			<div class="field-block">
				<label>æœ€çµ‚æ¥åº—æ—¥</label>
				<input type="date" id="f_last_visit" />
			</div>

			<hr style="border:0;border-top:2px dashed var(--line);margin:1rem 0;">

			<!-- B. ã‚¹ã‚¿ã‚¤ãƒ« / å¥½ã¿ -->
			<div class="field-block">
				<label>èª•ç”Ÿæ—¥</label>
				<input type="text" id="f_birthday" placeholder="10/12 ã¨ã‹ã§OK" />
				</div>

				<div class="field-block">
					<label>è¡€æ¶²å‹</label>
					<select id="f_blood">
						<option value="">ä¸æ˜</option>
						<option value="A">A</option>
						<option value="B">B</option>
						<option value="O">O</option>
						<option value="AB">AB</option>
					</select>
				</div>

				<div class="field-block">
					<label>å¹´é½¢</label>
					<input type="text" id="f_age" placeholder="30ä»£ / 20ä»£å¾ŒåŠ ã¨ã‹ã–ã£ãã‚Šã§ã‚‚OK" />
				</div>

				<div class="field-block">
					<label>ã‚ˆãé£²ã‚€ãŠé…’</label>
					<input type="text" id="f_drink" placeholder="ãƒã‚¤ãƒœãƒ¼ãƒ« / ç”˜ã„ç³» / ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ / ãƒãƒ³ã‚¢ãƒ« etc" />
				</div>

				<div class="field-block">
					<label>ã‚¿ãƒã‚³</label>
					<input type="text" id="f_smoke" placeholder="å¸ã† / å¸ã‚ãªã„ / éŠ˜æŸ„ etc" />
				</div>

				<hr style="border:0;border-top:2px dashed var(--line);margin:1rem 0;">

				<!-- C. æ¥åº—æƒ…å ± -->
				<div class="field-block">
					<label>åˆæ¥åº—æ—¥</label>
					<input type="date" id="f_first_visit" />
				</div>

				<div class="field-block">
					<label>æ¥åº—ã®ãã£ã‹ã‘ï¼ˆçµŒç·¯ï¼‰</label>
					<input type="text" id="f_how_found" placeholder="ç´¹ä»‹ / SNSã§è¦‹ãŸ / ãƒ•ãƒªãƒ¼ã§å…¥åº— ãªã©" />
				</div>

				<div class="field-block">
					<label>æ¥åº—å›æ•°</label>
					<input type="number" id="f_visit_count" min="0" value="0" />
				</div>

				<div class="field-block">
					<label>æ¥åº—ãƒšãƒ¼ã‚¹ãƒ»æ›œæ—¥/æ™‚é–“å¸¯</label>
					<input type="text" id="f_visit_pattern" placeholder="é‡‘æ›œã®çµ‚é›»å‰ / çµ¦æ–™æ—¥å¾Œã®åœŸæ›œ ãªã©" />
				</div>

				<div class="field-block">
					<label>ä½ã‚“ã§ã‚‹ã‚¨ãƒªã‚¢</label>
					<input type="text" id="f_area" placeholder="åŒ—ä»™å° / æ±äº¬ / çœŒå¤– ãªã©" />
				</div>

				<div class="field-block">
					<label>è·æ¥­</label>
					<input type="text" id="f_job" placeholder="IT / è‡ªå–¶æ¥­ / ä¼šç¤¾å“¡ ãªã©" />
				</div>

				<div class="field-block">
					<label>å½¼å¥³ãƒ»å«ã„ã‚‹ï¼Ÿ</label>
					<select id="f_has_partner">
						<option value="">ä¸æ˜</option>
						<option value="ã‚ã‚Š">ã‚ã‚Š</option>
						<option value="ãªã—">ãªã—</option>
					</select>
				</div>

				<hr style="border:0;border-top:2px dashed var(--line);margin:1rem 0;">

				<!-- D. ä¼šè©±ã‚­ãƒ¼ -->
				<div class="field-block">
					<label>å¥½ããªã‚‚ã®ï¼ˆç››ã‚Šä¸ŠãŒã‚‹è©±é¡Œï¼‰</label>
					<textarea id="f_likes" placeholder="ã‚¢ãƒ‹ãƒ¡/è»Š/é‡£ã‚Š/ã‚¢ã‚¤ãƒ‰ãƒ«/ã‚¹ãƒãƒœ/ä»•äº‹è¤’ã‚ã‚‰ã‚Œã‚‹ã®å¥½ã ãªã©"></textarea>
				</div>

				<div class="field-block">
					<label>NGè©±é¡Œï¼ˆåœ°é›·â€¼ï¼‰</label>
					<textarea id="f_ng_topics" placeholder="å¹´é½¢ã‚¤ã‚¸ã‚ŠNG / å®¶åº­ã®è©±ãµã‚Œãªã„ã§ã€ãªã©"></textarea>
				</div>

				<!-- E. ãƒ¡ãƒ¢ -->
				<div class="field-block">
					<label>ãƒ¡ãƒ¢ğŸ“</label>
					<textarea id="f_memo" placeholder=""></textarea>
				</div>

				<button class="save-btn" id="saveCustomerBtn">ğŸ’— ã“ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹</button>
				<button class="delete-btn" id="deleteCustomerBtn">ğŸ—‘ ã“ã®ãŠå®¢ã•ã‚“ã‚’å‰Šé™¤ã™ã‚‹</button>
			</div>
		</div>

			<!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
			<div class="footer-nav">
				<a class="back-link" id="backLink" href="#">â† é€²æ—ãƒšãƒ¼ã‚¸ã«ã‚‚ã©ã‚‹</a>
			</div>
	</div>

	<script>
		// â˜…ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ Web ã‚¢ãƒ—ãƒªã® URL ã«å¤‰ãˆã¦ã­
		const API_URL = "https://script.google.com/macros/s/AKfycbwZy842pl9a5bsSFH1trXhW7-hIByswRWAguxwgeCsf-8Ujw2MRFJ7N7cypExhmehlR/exec";

		// URLã® ?cast=saki ã¿ãŸã„ãªã®ã‚’èª­ã¿å–ã‚‹
		const params = new URLSearchParams(window.location.search);
		const cast = params.get("cast"); // ä¾‹: "saki", "maru", "kaede"...

		// cast ã‚’è¡¨ç¤ºç”¨ã®åå‰ï¼ˆã²ã‚‰ãŒãªï¼‹ã¡ã‚ƒã‚“ï¼‰ã«å¤‰æ›
		function castDisplayName(id){
			if (id === "saki")  return "ã•ãã¡ã‚ƒã‚“";
			if (id === "kaede") return "ã‹ãˆã§ã¡ã‚ƒã‚“";
			if (id === "mea")   return "ã‚ã‚ã¡ã‚ƒã‚“";
			if (id === "oto")   return "ãŠã¨ã¡ã‚ƒã‚“";
			if (id === "maru")  return "ã¾ã‚‹ã¡ã‚ƒã‚“";
			return id || "ãªã¾ãˆæœªè¨­å®š";
		}

		// ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œâ—â—ã¡ã‚ƒã‚“ã®ãƒšãƒ¼ã‚¸ğŸ’Ÿï¼ˆåº—é•·ã¯è¦‹ã‚Œãªã„ã‚ˆï¼‰ã€ â€»æ–‡è¨€ã¯å¥½ã¿ã§å¤‰ãˆã¦OK
			document.getElementById("castName").textContent =
  castDisplayName(cast) + " ã®ãƒšãƒ¼ã‚¸";

		// ç¾åœ¨ã®ç·¨é›†å¯¾è±¡ indexã€‚-1ãªã‚‰æ–°è¦
		let editingIndex = -1;

		// å…¨ãŠå®¢ã•ã‚“ãƒ‡ãƒ¼ã‚¿ï¼ˆcustomerAPI.gs ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãã®ã¾ã¾ï¼‰
		let customers = [];

		// â˜…æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç©ºãªã‚‰å…¨ä»¶è¡¨ç¤ºï¼‰
		let searchKeyword = "";

		// id â†’ customersé…åˆ—ã® index ã‚’å¼•ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒãƒƒãƒ—
		let customerIndexMap = {};

		// æ¨ã•ã‚Œåº¦(0-5)
		let tempOsareLevel = 0;

		// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ï¼šã„ã¾è¡¨ç¤ºã—ã¦ã„ã‚‹å¹´æœˆ
		var currentCalYear;
		var currentCalMonth;

		let selectedDate = "";
		let currentSelectedCell = null; // â˜…è¿½åŠ ï¼ˆä»Šé¸æŠä¸­ã®ãƒã‚¹ï¼‰

		let allCustomers = [];      // API ã‹ã‚‰å…¨éƒ¨å…¥ã‚Œã‚‹ã¨ã“ã‚
		let filteredCustomers = []; // æ¤œç´¢ã‚„çµã‚Šè¾¼ã¿å¾Œï¼ˆãªã‘ã‚Œã° allCustomers ã¨åŒã˜ï¼‰

		// ========= UIåˆæœŸåŒ– =========
		function initStaticUI(){

			// æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ï¼ˆè‡ªåˆ†ã®é€²æ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ï¼‰
			const back = document.getElementById("backLink");
			if (cast) {
				back.setAttribute("href", "view.html?cast=" + encodeURIComponent(cast));
			} else {
				back.setAttribute("href", "view.html");
			}
		}

		// ========= æ¨ã•ã‚Œãƒ©ãƒ³ã‚¯UI =========
		function renderOsarePicker(){
			const hearts = document.querySelectorAll(".osare-heart-btn");
			hearts.forEach(btn=>{
				const level = Number(btn.dataset.level);
				if(level <= tempOsareLevel){
					btn.classList.add("active");
				} else {
					btn.classList.remove("active");
				}
			});
			document.getElementById("osareLevelText").textContent = tempOsareLevel;
		}

		function setupOsarePicker(){
			const picker = document.getElementById("osarePicker");
			picker.addEventListener("click",(e)=>{
				const t = e.target.closest(".osare-heart-btn");
				if(!t) return;
				tempOsareLevel = Number(t.dataset.level);
				renderOsarePicker();
			});
		}

		// ========= ä»Šæ—¥ã®æ¥åº—ãƒ­ã‚° =========
		async function logTodayVisit() {
			if (!cast) {
				alert("ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ ?cast=â—¯â—¯ ã‚’ä»˜ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã­ï¼ï¼ˆä¾‹: .html?cast=sakiï¼‰");
				return;
			}
			if (editingIndex === -1) {
				alert("ã¾ãšä¸€è¦§ã‹ã‚‰ä»Šæ—¥æ¥åº—ã—ãŸãŠå®¢ã•ã‚“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã‚“ã§ã­ï¼");
				return;
			}

			var c = customers[editingIndex];
			if (!c.id) {
				alert("ã¾ã ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„ãŠå®¢ã•ã‚“ã§ã™ã€‚\nå…ˆã«ã€Œä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚’ã¤ã‘ã¦ã­ï¼");
				return;
			}

			var today = new Date();
			var y = today.getFullYear();
			var m = today.getMonth() + 1;
			var d = today.getDate();
			var dateStr =
				y + "-" +
				("0" + m).slice(-2) + "-" +
				("0" + d).slice(-2);

			try {
				var res = await fetch(API_URL + "?mode=visitlog", {
					method: "POST",
					body: JSON.stringify({
						cast: cast,
						customerId: c.id,
						visitDate: dateStr
					})
				});
				var json = await res.json();
				if (json.status === "ok") {
					alert("ä»Šæ—¥ã®æ¥åº—ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸâœ¨");
    				// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒä»Šæœˆã‚’è¡¨ç¤ºä¸­ãªã‚‰å†èª­ã¿è¾¼ã¿
					loadCalendar(currentCalYear, currentCalMonth);
				} else {
					console.error("visitlog error:", json);
					alert("æ¥åº—ãƒ­ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦");
				}
			} catch (err) {
				console.error("visitlog fetch error:", err);
				alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§æ¥åº—ãƒ­ã‚°ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸâ€¦");
			}
		}

		// ========= API å‘¼ã³å‡ºã— =========

		// â˜…ä»Šã®ã€Œæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã¨ã€Œä¸¦ã³é †ã€ã§ä¸¦ã¹ãŸçµæœã‚’ index ã®é…åˆ—ã§è¿”ã™
function buildViewIndices() {
  const kw = (searchKeyword || "").trim().toLowerCase();

  const sortSelect = document.getElementById("sortMode");
  const mode = sortSelect ? sortSelect.value : "rank";

  // [0,1,2,...] ã¿ãŸã„ãªå…ƒé…åˆ—ã® index ã®ãƒªã‚¹ãƒˆ
  const indices = customers.map((_, idx) => idx);

  // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
  const filtered = indices.filter(i => {
    if (!kw) return true;
    const c = customers[i];
    const text =
      ((c.customerName || "") + " " + (c.memo || "")).toLowerCase();
    return text.includes(kw);
  });

  // æ—¥ä»˜ã‚’å®‰å…¨ã« Date ã«ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  function toDateSafe(v) {
    if (!v) return new Date("1970-01-01");
    const d = new Date(v);
    return isNaN(d.getTime()) ? new Date("1970-01-01") : d;
  }

  // ä¸¦ã³æ›¿ãˆ
  if (mode === "rank") {
    // æ¨ã•ã‚Œãƒ©ãƒ³ã‚¯ â†’ æœ€çµ‚æ¥åº—
    filtered.sort((ia, ib) => {
      const a = customers[ia];
      const b = customers[ib];
      const ra = Number(a.heartRank || 0);
      const rb = Number(b.heartRank || 0);
      if (ra !== rb) return rb - ra;

      const da = toDateSafe(a.lastVisit);
      const db = toDateSafe(b.lastVisit);
      return db - da;
    });
  } else if (mode === "last") {
    // æœ€çµ‚æ¥åº—ãŒæ–°ã—ã„é †
    filtered.sort((ia, ib) => {
      const da = toDateSafe(customers[ia].lastVisit);
      const db = toDateSafe(customers[ib].lastVisit);
      return db - da;
    });
  } else if (mode === "name") {
    // åå‰é †
    filtered.sort((ia, ib) => {
      const na = (customers[ia].customerName || "").toString();
      const nb = (customers[ib].customerName || "").toString();
      return na.localeCompare(nb, "ja");
    });
  }

  return filtered;
}

		// ä¸€è¦§å–å¾—ï¼ˆcastã”ã¨ï¼‰
		async function fetchCustomerList() {
			if (!cast) return;

			try {
				const url = `${API_URL}?mode=list&cast=${encodeURIComponent(cast)}`;
				const res = await fetch(url);
				const json = await res.json();
				if (json.status === "ok") {
					customers = json.data || [];
				} else {
					console.error("list error:", json);
					customers = [];
				}
			} catch (err) {
				console.error("fetch list error:", err);
				customers = [];
			}
		}

		// ä¿å­˜ï¼ˆæ–°è¦ãƒ»æ›´æ–°ä¸¡æ–¹ï¼‰
		async function saveCustomerToServer(obj) {
			const res = await fetch(`${API_URL}?mode=save`, {
				method: "POST",
				body: JSON.stringify(obj)
			});
			const json = await res.json();
			return json;
		}

		// å‰Šé™¤
		async function deleteCustomerOnServer(id) {
			const res = await fetch(`${API_URL}?mode=delete`, {
				method: "POST",
				body: JSON.stringify({ id })
			});
			const json = await res.json();
			return json;
		}

		// æœˆåˆ¥ã®æ¥åº—æ•°ï¼ˆå…¨å“¡åˆ†ï¼‰ã‚’å–ã£ã¦ãã‚‹
		async function fetchVisitStats(year, month) {
			try {
				var url = API_URL + "?mode=visitstats"
					+ "&year=" + encodeURIComponent(year)
					+ "&month=" + encodeURIComponent(month);
				var res = await fetch(url);
				var json = await res.json();
				if (json.status === "ok") {
    				// æœŸå¾…ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: [{date:"2025-01-03", count:2}, ...]
					return json.data || [];
				} else {
					console.error("visitstats error:", json);
					return [];
				}
			} catch (err) {
				console.error("visitstats fetch error:", err);
				return [];
			}
		}

		// ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ =========
		function buildCalendarGrid(year, month, stats) {
			var grid = document.getElementById("calendarGrid");
			if (!grid) return;

			// stats ã‚’ãƒãƒƒãƒ—åŒ–: { "yyyy-MM-dd": count }
			var map = {};
			for (var i = 0; i < stats.length; i++) {
				var s = stats[i];
				if (s.date) {
					map[s.date] = Number(s.count || 0);
				}
			}

			grid.innerHTML = "";

			var weekdays = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
			for (var w = 0; w < 7; w++) {
				var wd = document.createElement("div");
					wd.className = "cal-weekday";
					wd.textContent = weekdays[w];
					grid.appendChild(wd);
			}

			// å½“æœˆã®æƒ…å ±
			var first = new Date(year, month - 1, 1);
			var firstWeekday = first.getDay(); // 0(æ—¥)ã€œ6(åœŸ)
			var daysInMonth = new Date(year, month, 0).getDate();

			// å‰ã®ç©ºç™½ãƒã‚¹
			for (var e = 0; e < firstWeekday; e++) {
				var emptyCell = document.createElement("div");
					emptyCell.className = "calendar-day empty";
					grid.appendChild(emptyCell);
			}

			var today = new Date();
			var todayStr =
				today.getFullYear() + "-" +
				("0" + (today.getMonth() + 1)).slice(-2) + "-" +
				("0" + today.getDate()).slice(-2);

			// æ—¥ä»˜ãƒã‚¹
			for (var day = 1; day <= daysInMonth; day++) {
				var cell = document.createElement("div");
					cell.className = "calendar-day";

				var dateStr =
					year + "-" +
					("0" + month).slice(-2) + "-" +
					("0" + day).slice(-2);

				if (dateStr === todayStr) {
					cell.className += " today";
				}

				// â˜…ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ—¥ä»˜ã®è©³ç´°ã‚’è¡¨ç¤º ï¼† ã‚­ãƒ©ãƒƒã¨é¸æŠ
				cell.addEventListener("click", (function(d, el) {
					return function () {
						// æ—¥ä»˜ã‚’è¦šãˆã¦ãŠãï¼ˆå¿…è¦ãªã‚‰ä½¿ã†ï¼‰
						selectedDate = d;

						// ã„ã¾ã¾ã§é¸æŠã•ã‚Œã¦ãŸãƒã‚¹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å¤–ã™
						if (currentSelectedCell) {
							currentSelectedCell.classList.remove("is-selected");
						}

						// ä»ŠæŠ¼ã—ãŸãƒã‚¹ã‚’é¸æŠçŠ¶æ…‹ã«
						currentSelectedCell = el;
						currentSelectedCell.classList.add("is-selected");

						// ãã®æ—¥ã®æ¥åº—ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¡¨ç¤º
						showVisitDetail(d);
					};
				})(dateStr, cell));

				var num = document.createElement("div");
					num.className = "calendar-day-num";
					num.textContent = day;

					cell.appendChild(num);

				var count = map[dateStr] || 0;
				if (count > 0) {
					var badge = document.createElement("div");
						badge.className = "calendar-day-badge";
						badge.textContent = count + "ä»¶";
						cell.appendChild(badge);
					}

				grid.appendChild(cell);
			}

			grid.appendChild(cell);
		}

		// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿
		async function loadCalendar(year, month) {
			currentCalYear = year;
			currentCalMonth = month;

			var title = document.getElementById("calTitle");
			if (title) {
				title.textContent = year + "å¹´" + month + "æœˆ";
			}

			var stats = await fetchVisitStats(year, month);
			buildCalendarGrid(year, month, stats);
		}

		// â–¼ æŒ‡å®šã®æ—¥ä»˜ã®æ¥åº—ãƒ­ã‚°ï¼ˆèª°ãŒæ¥ãŸã‹ï¼‰ã‚’å–å¾—
		// GASå´: ?mode=visitdetail&cast=xxx&date=yyyy-MM-dd ã‚’å®Ÿè£…ã—ã¦ãŠãæƒ³å®š
		async function fetchVisitDetail(dateStr) {
			if (!cast) return [];

			try {
				const url =
					`${API_URL}?mode=visitdetail` +
					`&cast=${encodeURIComponent(cast)}` +
					`&date=${encodeURIComponent(dateStr)}`;

				const res = await fetch(url);
				const json = await res.json();
				if (json.status === "ok") {
					// æœŸå¾…ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: [{ customerName: "ãŸãªã‹ã•ã‚“", ... }, ...]
					return json.data || [];
				} else {
					console.error("visitdetail error:", json);
					return [];
				}
			} catch (err) {
				console.error("visitdetail fetch error:", err);
				return [];
			}
		}

		// â–¼ ä¸‹ã®ãƒ”ãƒ³ã‚¯æ ã«ã€Œã“ã®æ—¥èª°ãŒæ¥ãŸã‹ã€ã‚’è¡¨ç¤º
		function renderVisitDetailBox(dateStr, logs) {
			const box = document.getElementById("calendarDetail");
			if (!box) return;

			if (!logs || logs.length === 0) {
				box.innerHTML = `ğŸ“… <strong>${dateStr}</strong> ã®æ¥åº—ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚`;
				return;
			}

			const items = logs
			.map(l => `<li>${l.customerName || "(åå‰ãªã—)"}</li>`)
			.join("");

			box.innerHTML = `
				ğŸ“… <strong>${dateStr}</strong> ã®æ¥åº—ãƒ¡ãƒ³ãƒãƒ¼<br/>
				<ul>${items}</ul>
			`;
		}

		// visit_log ã®å‰Šé™¤API
		async function deleteVisitLogOnServer(rowIndex, customerId) {
			const res = await fetch(API_URL + "?mode=visitlog_delete", {
				method: "POST",
				body: JSON.stringify({ rowIndex, customerId })
			});
			return await res.json();
		}

		// visit_log ã®æ—¥ä»˜æ›´æ–°API
		async function updateVisitLogOnServer(rowIndex, customerId, visitDate) {
			const res = await fetch(API_URL + "?mode=visitlog_update", {
				method: "POST",
				body: JSON.stringify({ rowIndex, customerId, visitDate })
			});
			return await res.json();
		}

		// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®1æ—¥ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã¨ã
		// æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã¨ãï¼šãã®æ—¥ã®æ¥åº—ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã€Œã“ã“ã«å‡ºã‚‹ã‚ˆğŸ“…ã€ã«è¡¨ç¤ºï¼‹ãƒ—ãƒ­ãƒ•ç·¨é›†ãƒœã‚¿ãƒ³
		async function onCalendarDayClick(dateStr) {
			const infoBox = document.getElementById("calendarDayInfo");
			if (!infoBox) return;

			infoBox.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

			try {
				const url = `${API_URL}?mode=visitdetail`
					+ `&cast=${encodeURIComponent(cast || "")}`
					+ `&date=${encodeURIComponent(dateStr)}`;

				const res = await fetch(url);
				const json = await res.json();

				if (json.status !== "ok") {
					console.error("visitdetail error:", json);
					infoBox.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦";
					return;
				}

				const list = json.data || [];

				if (list.length === 0) {
					infoBox.textContent = `${dateStr} ã®æ¥åº—ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“`;
					return;
				}

				// ä¸­èº«ã‚’çµ„ã¿ç«‹ã¦
				const wrapper = document.createElement("div");
				wrapper.style.display = "flex";
				wrapper.style.flexDirection = "column";
				wrapper.style.gap = "0.25rem";

				const title = document.createElement("div");
				title.textContent = `${dateStr} ã®æ¥åº—ãƒ¡ãƒ³ãƒãƒ¼`;
				title.style.fontWeight = "700";
				title.style.marginBottom = "0.25rem";
				wrapper.appendChild(title);

				list.forEach(v => {
					const row = document.createElement("div");
					row.style.display = "flex";
					row.style.alignItems = "center";
					row.style.justifyContent = "space-between";
					row.style.gap = "0.3rem";

					const name = document.createElement("div");
					name.textContent = v.customerName || "(åå‰ãªã—)";
					row.appendChild(name);

					// ãƒ—ãƒ­ãƒ•ç·¨é›†ãƒœã‚¿ãƒ³
					const btn = document.createElement("button");
					btn.textContent = "ãƒ—ãƒ­ãƒ•ç·¨é›†";
					btn.style.fontSize = "0.7rem";
					btn.style.padding = "0.2rem 0.5rem";
					btn.style.borderRadius = "999px";
					btn.style.border = "1px solid #ffd4ec";
					btn.style.background = "#fff";
					btn.style.color = "#ff66aa";
					btn.style.cursor = "pointer";

					btn.addEventListener("click", () => {
						const idx = customerIndexMap[v.customerId];
						if (idx == null) {
							alert("ã“ã®ãŠå®¢ã•ã‚“ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒä¸€è¦§ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸâ€¦");
							return;
						}

						// å³å´ã®ãƒ—ãƒ­ãƒ•ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã‚€
						loadToForm(idx);
						// ãƒ•ã‚©ãƒ¼ãƒ ãŒç”»é¢å¤–ã«ã‚ã£ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
						const editCard = document.querySelector(".edit-card");
						if (editCard) {
							editCard.scrollIntoView({ behavior: "smooth", block: "start" });
						}
					});

					row.appendChild(btn);
					wrapper.appendChild(row);
				});

				infoBox.innerHTML = "";
				infoBox.appendChild(wrapper);

			} catch (err) {
				console.error("visitdetail fetch error:", err);
				infoBox.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸâ€¦";
			}
		}


		// æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã¨ãï¼šãã®æ—¥ã®æ¥åº—ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã€Œã“ã“ã«å‡ºã‚‹ã‚ˆğŸ“…ã€ã«è¡¨ç¤º
		async function onCalendarDayClick(dateStr) {
			const infoBox = document.getElementById("calendarDayInfo");
			if (!infoBox) return;

			infoBox.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

			try {
				const url = `${API_URL}?mode=visitdetail`
					+ `&cast=${encodeURIComponent(cast || "")}`
					+ `&date=${encodeURIComponent(dateStr)}`;

				const res = await fetch(url);
				const json = await res.json();

				if (json.status !== "ok") {
					console.error("visitdetail error:", json);
					infoBox.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦";
					return;
				}

				const list = json.data || [];

				if (list.length === 0) {
					infoBox.textContent = `${dateStr} ã®æ¥åº—ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“`;
					return;
				}

				const names = list.map(v => v.customerName || "(åå‰ãªã—)");

				infoBox.textContent = `${dateStr} ã®æ¥åº—ãƒ¡ãƒ³ãƒãƒ¼ï¼š` + names.join("ã€");

				// â˜…ã‚‚ã—ã“ã“ã§ã€Œç·¨é›†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€ã‚‚é–‹ããŸã„ãªã‚‰ã€
				//   ã“ã“ã‹ã‚‰è‡ªåˆ†ã® openVisitPopup(dateStr, list) ã¿ãŸã„ãªé–¢æ•°ã‚’å‘¼ã¹ã°OK
				// openVisitPopup(dateStr, list);

			} catch (err) {
				console.error("visitdetail fetch error:", err);
				infoBox.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸâ€¦";
			}
		}

		// åå‰ã‚’å®‰å…¨ã«è¡¨ç¤ºã™ã‚‹ç”¨ï¼ˆ< > ã¨ã‹ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
		function esc(str) {
			if (str == null) return "";
			return String(str)
			.replace(/&/g, "&amp;")
			.replace(/</g, "&lt;")
			.replace(/>/g, "&gt;");
		}

		function showVisitDetail(dateStr) {
			const info = document.getElementById("calendarDayInfo");
			if (info) info.style.display = "none";
			const url = `${API_URL}?mode=visitdetail&cast=${encodeURIComponent(cast)}&date=${encodeURIComponent(dateStr)}`;

			fetch(url)
			.then(r => r.json())
			.then(res => {
				if (res.status !== "ok") {
					console.error("visitdetail error:", res);
					return;
				}

				const list = res.data || [];
				let html = `
  <div class="visit-detail-card">
    <div class="visit-detail-header">
      <div class="visit-detail-title">ğŸ“… ${esc(dateStr)} ã®æ¥åº—ãƒ­ã‚°</div>
      <div class="visit-detail-caption">
        ã“ã®æ—¥ã«æ¥ã¦ãã‚ŒãŸãŠå®¢ã•ã‚“ãƒªã‚¹ãƒˆã ã‚ˆğŸª„
      </div>
    </div>
`;

if (list.length === 0) {
  html += `
    <div class="visit-detail-empty">
      ã¾ã æ¥åº—ãƒ­ã‚°ãŒãªã„ã¿ãŸã„â€¦ğŸ¥¹<br>
      ã€Œä»Šæ—¥ã®æ¥åº—ãƒ­ã‚°ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ã¿ã¦ã­ã€‚
    </div>
  `;
} else {
  html += `<div class="visit-detail-list">`;

  list.forEach(item => {
    const name = item.customerName || "(ãªãªã—ã•ã‚“)";
html += `
  <div class="visit-detail-item">
    <div class="visit-detail-main">
      <span class="visit-detail-icon">ğŸ¸</span>

      <button class="visit-detail-name-btn"
  onclick="openCustomerFromVisit('${item.customerId}')">
  ${esc(name)}
</button>

    </div>

    <div class="visit-detail-actions">
      <button class="visit-btn visit-btn-edit"
        onclick="editVisit('${item.customerId}','${dateStr}')">ç·¨é›†âœï¸</button>
      <button class="visit-btn visit-btn-delete"
        onclick="deleteVisit('${item.customerId}','${dateStr}')">å‰Šé™¤ğŸ—‘</button>
    </div>
  </div>
`;

  });

  html += `</div>`; // visit-detail-list
}

html += `</div>`; // â˜… visit-detail-card ã‚’æœ€å¾Œã«é–‰ã˜ã‚‹


				const box = document.getElementById("visitDetailBox");
				if (box) {
					box.innerHTML = html;
				}
			})
			.catch(err => {
				console.error("visitdetail fetch error:", err);
			});
		}

		// ========= æ¥åº—ãƒ­ã‚°ç·¨é›†ãƒ»å‰Šé™¤ =========
		function editVisit(customerId, dateStr) {
			const newDate = prompt("æ–°ã—ã„æ¥åº—æ—¥ã‚’å…¥åŠ› (YYYY-MM-DD):", dateStr);
			if (!newDate) return;

			const cast = currentCast;

			const body = {
				mode: "visitlog_edit",
    			id: customerId + "_" + dateStr, // visit_log ã® rowId ã«åˆã‚ã›ã‚‹ãªã‚‰ã“ã“èª¿æ•´
				customerId: customerId,
				cast: cast,
				visitDate: newDate
			};

			fetch(API_URL, {
				method: "POST",
				body: JSON.stringify(body)
			})
			.then(r => r.json())
			.then(res => {
				alert("æ›´æ–°ã—ã¾ã—ãŸï¼");
				showVisitDetail(newDate);
			});
		}

		function deleteVisit(customerId, dateStr) {
			if (!confirm("å‰Šé™¤ã—ã¦OKï¼Ÿ")) return;

			const body = {
				mode: "visitlog_delete",
				id: customerId + "_" + dateStr
			};

			fetch(API_URL, {
				method: "POST",
				body: JSON.stringify(body)
			})
			.then(r => r.json())
			.then(res => {
				alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
				showVisitDetail(dateStr);
			});
		}

		// ========= ãƒªã‚¹ãƒˆæç”» =========
		function makeHeartString(level) {
			const icons = ["ğŸ¤", "ğŸ’™", "ğŸ’š", "ğŸ’›", "ğŸ§¡", "ğŸ’—"];
			level = Number(level) || 0;

			// ç¯„å›²å¤–ãƒ¬ãƒ™ãƒ«ã‚’é˜²ã
			if (level < 0) level = 0;
			if (level > 5) level = 5;

			return icons[level];
		}

		function applySortAndRender() {
			const select = document.getElementById("sortMode");
			const mode = select ? select.value : "rank";

			// ä»ŠæŒã£ã¦ã‚‹ customers ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚½ãƒ¼ãƒˆ
			const list = [...customers];

			// æ—¥ä»˜ã‚’å®‰å…¨ã« Date ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
			function toDateSafe(v) {
				if (!v) return new Date("1970-01-01");
				const d = new Date(v);
				return isNaN(d.getTime()) ? new Date("1970-01-01") : d;
			}

			if (mode === "rank") {
				// æ¨ã•ã‚Œãƒ©ãƒ³ã‚¯é †ï¼ˆheartRank é™é † â†’ æœ€çµ‚æ¥åº—ãŒæ–°ã—ã„é †ï¼‰
				list.sort((a, b) => {
					const ra = Number(a.heartRank || 0);
					const rb = Number(b.heartRank || 0);
					if (ra !== rb) return rb - ra;   // ãƒ©ãƒ³ã‚¯é«˜ã„é †

					const da = toDateSafe(a.lastVisit);
					const db = toDateSafe(b.lastVisit);
					return db - da;                  // æ–°ã—ã„æ—¥ä»˜ãŒå…ˆ
				});
			} else if (mode === "last") {
				// æœ€çµ‚æ¥åº—ãŒæ–°ã—ã„é †
				list.sort((a, b) => {
					const da = toDateSafe(a.lastVisit);
					const db = toDateSafe(b.lastVisit);
					return db - da;
				});
			} else if (mode === "name") {
				// åå‰é †ï¼ˆcustomerName ã®äº”åéŸ³é †ï¼‰
				list.sort((a, b) => {
					const na = (a.customerName || "").toString();
					const nb = (b.customerName || "").toString();
					return na.localeCompare(nb, "ja");
				});
			}

			// ã‚½ãƒ¼ãƒˆçµæœã‚’å…¬å¼ customers ã«åæ˜ ã—ã¦ã‹ã‚‰æç”»
			customers = list;
			renderCustomerList();
		}

		function renderCustomerList() {
			const listEl  = document.getElementById("customerList");
			const countEl = document.getElementById("customerCount");

			listEl.innerHTML = "";

			if (countEl) {
				countEl.textContent = `å…¨${customers.length}äºº`;
			}

			customerIndexMap = {};

			// â˜…ã“ã“ã§ã€Œæ¤œç´¢ï¼‹ã‚½ãƒ¼ãƒˆå¾Œã®ä¸¦ã³ã€ã‚’æ±ºã‚ã‚‹
			const indices = buildViewIndices();

			if (indices.length === 0) {
				const emptyMsg = document.createElement("div");
				emptyMsg.style.fontSize   = ".75rem";
				emptyMsg.style.color      = "#a07799";
				emptyMsg.style.textAlign  = "center";
				emptyMsg.style.padding    = ".75rem 0";
				emptyMsg.textContent      =
					"æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‹ãŠå®¢ã•ã‚“ãŒã„ã¾ã›ã‚“â€¦ğŸ”\nã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ä¸¦ã³é †ã‚’å¤‰ãˆã¦ã¿ã¦ã­ã€‚";
				listEl.appendChild(emptyMsg);
				return;
			}

			// ä¸¦ã³é †ã«æ²¿ã£ã¦ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
			indices.forEach(idx => {
				const c = customers[idx];

				// id â†’ index ãƒãƒƒãƒ—ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã‹ã‚‰ã‚‚ä½¿ãˆã‚‹ï¼‰
				if (c.id) {
					customerIndexMap[c.id] = idx;
				}

				const item = document.createElement("div");
				item.className = "cust-item";
				item.dataset.index = idx;

				item.addEventListener("click", () => {
					loadToForm(idx);
				});

				// ä¸Šæ®µ
				const topRow = document.createElement("div");
				topRow.className = "cust-toprow";

				const leftWrap = document.createElement("div");
				leftWrap.className = "cust-leftname";

				const nm = document.createElement("div");
				nm.textContent = c.customerName || "(åå‰ãªã—)";

				const hearts = document.createElement("div");
				hearts.className = "osare-hearts";
				hearts.textContent = makeHeartString(c.heartRank || 0);

				leftWrap.appendChild(nm);
				leftWrap.appendChild(hearts);
				topRow.appendChild(leftWrap);

				const contact = document.createElement("div");
				contact.className =
					"cust-contact-flag " + (c.exchangeContact ? "" : "no");
				contact.textContent = c.exchangeContact ? "é€£çµ¡å…ˆã‚ã‚Š" : "ã¾ã ";
				topRow.appendChild(contact);

				// ä¸‹æ®µ
				const bottomRow = document.createElement("div");
				bottomRow.className = "cust-bottomrow";

				const visitP = document.createElement("div");
				visitP.textContent =
					(c.visitFrequency || "") || "æ¥ã‚„ã™ã„æ™‚é–“ã¾ã ä¸æ˜";

				const lastV = document.createElement("div");
				lastV.textContent =
					c.lastVisit ? ("æœ€çµ‚: " + c.lastVisit) : "æœ€çµ‚æ¥åº—: ï¼Ÿ";

				bottomRow.appendChild(visitP);
				bottomRow.appendChild(lastV);

				item.appendChild(topRow);
				item.appendChild(bottomRow);
				listEl.appendChild(item);
			});
		}

		// ========= ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œ =========
		function clearForm(){
			editingIndex = -1;
			document.getElementById("editHint").textContent = "æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰";

			document.getElementById("f_display_name").value = "";
			tempOsareLevel = 0;
			renderOsarePicker();

			document.getElementById("f_has_contact").checked = false;
			document.getElementById("f_last_visit").value = "";

			document.getElementById("f_birthday").value = "";
			document.getElementById("f_blood").value = "";
			document.getElementById("f_age").value = "";
			document.getElementById("f_drink").value = "";
			document.getElementById("f_smoke").value = "";

			document.getElementById("f_first_visit").value = "";
			document.getElementById("f_how_found").value = "";
			document.getElementById("f_visit_count").value = "0";
			document.getElementById("f_visit_pattern").value = "";
			document.getElementById("f_area").value = "";
			document.getElementById("f_job").value = "";
			document.getElementById("f_has_partner").value = "";

			document.getElementById("f_likes").value = "";
			document.getElementById("f_ng_topics").value = "";
			document.getElementById("f_memo").value = "";

			// å‰Šé™¤ãƒœã‚¿ãƒ³OFF
			const delBtn = document.getElementById("deleteCustomerBtn");
			if (delBtn) {
				delBtn.disabled = true;
				delBtn.style.opacity = "0.5";
			}
		}

		function loadToForm(idx){
			editingIndex = idx;
			const c = customers[idx];

			document.getElementById("editHint").textContent =
			(c.customerName || "(åå‰ãªã—)") + " ã•ã‚“ã‚’ç·¨é›†";

			document.getElementById("f_display_name").value = c.customerName || "";
			tempOsareLevel = Number(c.heartRank || 0);
			renderOsarePicker();

			document.getElementById("f_has_contact").checked = !!c.exchangeContact;
			document.getElementById("f_last_visit").value = c.lastVisit || "";

			document.getElementById("f_birthday").value = c.birthday || "";
			document.getElementById("f_blood").value = c.bloodType || "";
			document.getElementById("f_age").value = c.age || "";
			document.getElementById("f_drink").value = c.favoriteAlcohol || "";
			document.getElementById("f_smoke").value = c.smoking || "";

			document.getElementById("f_first_visit").value = c.firstVisit || "";
			document.getElementById("f_how_found").value = c.entryReason || "";
			document.getElementById("f_visit_count").value =
				(c.visitCount != null ? c.visitCount : 0);
			document.getElementById("f_visit_pattern").value = c.visitFrequency || "";
			document.getElementById("f_area").value = c.area || "";
			document.getElementById("f_job").value = c.job || "";
			document.getElementById("f_has_partner").value = c.hasPartner || "";

			document.getElementById("f_likes").value = c.like || "";
			document.getElementById("f_ng_topics").value = c.ng || "";
			document.getElementById("f_memo").value = c.memo || "";

			// å‰Šé™¤ãƒœã‚¿ãƒ³ON
			const delBtn = document.getElementById("deleteCustomerBtn");
			if (delBtn) {
				delBtn.disabled = false;
				delBtn.style.opacity = "1";
			}
		}

		// ãƒ•ã‚©ãƒ¼ãƒ  â†’ APIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
		function buildCustomerFromForm(base) {
			const obj = base ? { ...base } : {};

			obj.cast         = cast || "";
			obj.castDisplay  = castDisplayName(cast);
			obj.customerName = document.getElementById("f_display_name").value.trim();
			obj.heartRank    = tempOsareLevel;
			obj.exchangeContact = document.getElementById("f_has_contact").checked;

			obj.lastVisit    = document.getElementById("f_last_visit").value.trim();
			obj.birthday     = document.getElementById("f_birthday").value.trim();
			obj.bloodType    = document.getElementById("f_blood").value.trim();
			obj.age          = document.getElementById("f_age").value.trim();
			obj.favoriteAlcohol = document.getElementById("f_drink").value.trim();
			obj.smoking      = document.getElementById("f_smoke").value;

			obj.firstVisit   = document.getElementById("f_first_visit").value.trim();
			obj.entryReason  = document.getElementById("f_how_found").value.trim();
			obj.visitCount   = Number(document.getElementById("f_visit_count").value || "0");
			obj.visitFrequency = document.getElementById("f_visit_pattern").value.trim();

			obj.area         = document.getElementById("f_area").value.trim();
			obj.job          = document.getElementById("f_job").value.trim();
			obj.hasPartner   = document.getElementById("f_has_partner").value;

			obj.like         = document.getElementById("f_likes").value.trim();
			obj.ng           = document.getElementById("f_ng_topics").value.trim();
			obj.memo         = document.getElementById("f_memo").value.trim();

			return obj;
		}

		async function saveCurrentForm(){
			if (!cast) {
				alert("cast ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ?cast=saki ã¿ãŸã„ã«ä»˜ã‘ã¦ã­ï¼‰");
				return;
			}

			// â˜… ä¿å­˜å‰ã® lastVisit ã‚’æ§ãˆã‚‹
			const prevLastVisit =
				(editingIndex >= 0 && customers[editingIndex])
				? (customers[editingIndex].lastVisit || "")
				: "";

			// æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Œã°å¼•ãç¶™ãï¼ˆç‰¹ã« idï¼‰
			const base  = (editingIndex >= 0) ? customers[editingIndex] : null;
			const newObj = buildCustomerFromForm(base);

			try {
				const json = await saveCustomerToServer(newObj);
				if (json.status !== "ok") {
					console.error("save error:", json);
					alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦(Â´;Ï‰;ï½€)");
					return;
				}

				// æ–°è¦ã®ã¨ãã¯ API å´ã§ä»˜ä¸ã•ã‚ŒãŸ id ã‚’åæ˜ 
				if (json.id) {
					newObj.id = json.id;
				}

				// ã„ã£ãŸã‚“ customers ã«åæ˜ 
				if (editingIndex === -1) {
					customers.push(newObj);
				} else {
					customers[editingIndex] = newObj;
				}

				// â˜…ã“ã“ã‹ã‚‰ï¼šä¸¦ã³æ›¿ãˆå¾Œã® index ã‚’å–ã‚Šç›´ã™
				const savedId = newObj.id;
				applySortAndRender();  // ä¸¦ã³æ›¿ãˆ & å†æç”»

				const newIndex = customers.findIndex(c => c.id === savedId);
				if (newIndex !== -1) {
					editingIndex = newIndex;
					loadToForm(editingIndex);
				}

				alert("ä¿å­˜ã—ã¾ã—ãŸğŸ’—");


				// â˜…â˜…â˜… ã“ã“ã‹ã‚‰ï¼šæœ€çµ‚æ¥åº—æ—¥ã‚’æ‰‹ã§å¤‰ãˆãŸã‚‰ visitlog ã‚‚è‡ªå‹•è¿½åŠ  â˜…â˜…â˜…
				const newLastVisit = newObj.lastVisit || "";
				if (newLastVisit && newLastVisit !== prevLastVisit && newObj.id) {
					try {
						const vRes = await fetch(`${API_URL}?mode=visitlog`, {
							method: "POST",
							body: JSON.stringify({
								cast: cast,
								customerId: newObj.id,
								visitDate: newLastVisit
							})
						});
						const vJson = await vRes.json();
						if (vJson.status !== "ok") {
							console.error("visitlog on save error:", vJson);
						} else {
							console.log("visitlog added from save:", vJson);

							// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒãã®æœˆã‚’è¡¨ç¤ºã—ã¦ã„ã‚Œã°æ›´æ–°ï¼ˆã‚ã‚Œã°ãƒ©ãƒƒã‚­ãƒ¼ãã‚‰ã„ã®ãƒãƒªï¼‰
							if (currentCalYear && currentCalMonth) {
								const y = Number(newLastVisit.slice(0, 4));
								const m = Number(newLastVisit.slice(5, 7));
								if (y === currentCalYear && m === currentCalMonth) {
									await loadCalendar(currentCalYear, currentCalMonth);
								}
							}
						}
					} catch (err2) {
						console.error("visitlog on save fetch error:", err2);
					}
				}

			} catch (err) {
				console.error("save fetch error:", err);
				alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸâ€¦");
			}
		}


		async function deleteCurrentCustomer(){
			if (editingIndex === -1) {
				alert("ã¾ã ä¿å­˜ã•ã‚Œã¦ãªã„ãŠå®¢ã•ã‚“ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ğŸ™‡â€â™€ï¸");
				return;
			}

			const c = customers[editingIndex];
			const targetName = c.customerName || "ã“ã®ãŠå®¢ã•ã‚“";

			const ok = confirm(targetName + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
			if (!ok) return;

			try {
				const json = await deleteCustomerOnServer(c.id);
				if (json.status !== "ok") {
					console.error("delete error:", json);
					alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦");
					return;
				}

				customers.splice(editingIndex, 1);
				applySortAndRender();  // â†å‰Šé™¤å¾Œã‚‚ä¸¦ã³é †ã‚’æ›´æ–°
				clearForm();
				alert("å‰Šé™¤ã—ã¾ã—ãŸ");

			} catch (err) {
				console.error("delete fetch error:", err);
				alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸâ€¦");
			}
		}

		// ========= ã‚¤ãƒ™ãƒ³ãƒˆ =========
		document.getElementById("addCustomerBtn").addEventListener("click", ()=>{
			clearForm();
		});

		document.getElementById("saveCustomerBtn").addEventListener("click", ()=>{
			saveCurrentForm();
		});

		document.getElementById("deleteCustomerBtn").addEventListener("click", ()=>{
			deleteCurrentCustomer();
		});

		// â˜… ä»Šæ—¥ã®æ¥åº—ãƒ­ã‚°ãƒœã‚¿ãƒ³
		document.getElementById("logTodayBtn").addEventListener("click", function () {
			logTodayVisit();
		});

		// ä¸¦ã³æ›¿ãˆå¤‰æ›´æ™‚
const sortSelect = document.getElementById("sortMode");
if (sortSelect) {
  sortSelect.addEventListener("change", () => {
    renderCustomerList();
  });
}

// æ¤œç´¢ãƒœã‚¿ãƒ³ & Enter
const searchInput = document.getElementById("searchKeyword");
const searchBtn   = document.getElementById("searchRunBtn");

function runSearch() {
  if (!searchInput) return;
  searchKeyword = searchInput.value || "";
  renderCustomerList();
}

if (searchBtn && searchInput) {
  searchBtn.addEventListener("click", runSearch);
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      runSearch();
    }
  });
}
		// ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ãƒ—ãƒ­ãƒ•ç·¨é›†ç”»é¢ã‚’é–‹ã =========
function openCustomerProfile(customerId) {
  if (!customerId) return;

  // customerIndexMap ãŒ customerId -> index ã«ãªã£ã¦ã‚‹å‰æ
  const idx = customerIndexMap[customerId];

  if (idx == null) {
    alert("ã“ã®ãŠå®¢ã•ã‚“ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒä¸€è¦§ã«è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸâ€¦ï¼ˆä¸€åº¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ğŸ™ï¼‰");
    return;
  }

  loadToForm(idx);

  // ç·¨é›†ã‚¨ãƒªã‚¢ã¸ã‚¹ãƒƒã¨ç§»å‹•
  const editCard = document.querySelector(".edit-card");
  if (editCard) {
    editCard.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}

function openCustomerFromVisit(customerId) {
  const idx = customerIndexMap[customerId];
  if (idx == null) {
    alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¸€è¦§ã«è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆâ€¦ï¼ˆä¸€è¦§ã‚’å…ˆã«èª­ã¿è¾¼ã‚ã¦ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼‰");
    return;
  }

  loadToForm(idx);

  // ãƒ—ãƒ­ãƒ•ç·¨é›†ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const editCard = document.querySelector(".edit-card");
  if (editCard) editCard.scrollIntoView({ behavior: "smooth", block: "start" });
}



		// ========= åˆæœŸãƒ­ãƒ¼ãƒ‰ =========
		(async function init(){
			if (!cast) {
				alert("ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ ?cast=â—¯â—¯ ã‚’ä»˜ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã­ï¼ï¼ˆä¾‹: .html?cast=sakiï¼‰");
			}

			initStaticUI();
			setupOsarePicker();
			renderOsarePicker();

			// â˜… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸè¡¨ç¤ºï¼ˆä»Šæœˆï¼‰
			var now = new Date();
			currentCalYear  = now.getFullYear();
			currentCalMonth = now.getMonth() + 1;
			await loadCalendar(currentCalYear, currentCalMonth);

			// æœˆé€ã‚Šãƒœã‚¿ãƒ³
			var prevBtn = document.getElementById("calPrevBtn");
			var nextBtn = document.getElementById("calNextBtn");

			if (prevBtn) {
				prevBtn.addEventListener("click", function () {
					var y = currentCalYear;
					var m = currentCalMonth - 1;
					if (m < 1) {
						m = 12;
						y--;
					}
					loadCalendar(y, m);
				});
			}

			if (nextBtn) {
				nextBtn.addEventListener("click", function () {
					var y = currentCalYear;
					var m = currentCalMonth + 1;
					if (m > 12) {
						m = 1;
						y++;
					}
					loadCalendar(y, m);
				});
			}

			await fetchCustomerList();  // â˜…GASã‹ã‚‰ä¸€è¦§å–å¾—
			applySortAndRender();       // â†ä¸¦ã³æ›¿ãˆã—ã¦ã‹ã‚‰è¡¨ç¤º
			clearForm();
		})();

	</script>

</body>
</html>