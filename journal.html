<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>åº—é•·ã¨ã®äº¤æ›æ—¥è¨˜ğŸ““</title>
	<link rel="stylesheet" href="assets/common.css">
	<link rel="stylesheet" href="assets/journal.css">
</head>

<body>
	<div class="app-shell">

		<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
		<header class="header-card">
			<div class="header-title">åº—é•·ã¨ã®äº¤æ›æ—¥è¨˜</div>
			<div class="header-sub">ã€Œä»Šæ—¥ã©ã†ã ã£ãŸï¼Ÿã€ã‚’ã“ã£ãã‚Šæ•™ãˆã¦ã­ğŸ«¶</div>
			<div class="cast-pill">
				<div class="cast-pill-inner">
					ğŸ’Œ<span id="castName">[ãªã¾ãˆ]</span>
				</div>
			</div>
		</header>

		<!-- æ–°è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼ -->
		<section class="card">
			<div class="card-title">ä»Šæ—¥ã®ãã‚‚ã¡</div>
			<div class="mood-row" id="moodRow">
				<button type="button" class="mood-btn" data-mood="ğŸ˜Š">ğŸ˜Š ãŸã®ã—ã„</button>
				<button type="button" class="mood-btn" data-mood="ğŸ˜">ğŸ˜ ãµã¤ã†</button>
				<button type="button" class="mood-btn" data-mood="ğŸ˜­">ğŸ˜­ ã—ã‚“ã©ã„</button>
				<button type="button" class="mood-btn" data-mood="ğŸ”¥">ğŸ”¥ ãŒã‚“ã°ã‚ŠãŸã„</button>
				<button type="button" class="mood-btn" data-mood="ğŸ¥¹">ğŸ¥¹ ãã„ã¦ã»ã—ã„</button>
			</div>
			<textarea id="entryText" placeholder="ãã‚‡ã†ã®å‡ºå‹¤ã§ã‚ã£ãŸã“ã¨ãƒ»ã†ã‚Œã—ã‹ã£ãŸã“ã¨ãƒ»ãƒ¢ãƒ¤ã£ã¨ã—ãŸã“ã¨ãªã©ã€ãªã‚“ã§ã‚‚æ›¸ã„ã¦OKã ã‚ˆğŸ¾"></textarea>
				<div class="send-row">
					<button class="btn-send" id="sendBtn">åº—é•·ã«é€ã‚‹ğŸ“¨</button>
				</div>
		</section>

		<!-- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸€è¦§ -->

		<div class="list-title">ã“ã‚Œã¾ã§ã®æ—¥è¨˜</div>
		<div id="entryList"></div>
		<div class="footer-nav">
			<a class="back-link" id="backLink" href="#">â† é€²æ—ãƒšãƒ¼ã‚¸ã«ã‚‚ã©ã‚‹</a>
		</div>
	</div>

	<script>
		// â˜…ã“ã“ã‚’ã‚¹ãƒ¼ãƒ‘ãƒ¼APIã®URLã«ç½®ãæ›ãˆ
		const API_URL = "https://script.google.com/macros/s/AKfycbwZy842pl9a5bsSFH1trXhW7-hIByswRWAguxwgeCsf-8Ujw2MRFJ7N7cypExhmehlR/exec";

		const params = new URLSearchParams(location.search);
		const cast   = params.get("cast") || "";

		if (!cast) {
				alert("ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ ?cast=â—¯â—¯ ã‚’ä»˜ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã­ï¼ï¼ˆä¾‹: .html?cast=sakiï¼‰");
			}

		// æˆ»ã‚‹ãƒªãƒ³ã‚¯
		const back = document.getElementById("backLink");
		if (cast) {
			back.setAttribute("href", "view.html?cast=" + encodeURIComponent(cast));
		} else {
			back.setAttribute("href", "view.html");
		}

		function castDisplayName(id){
  if (id === "saki")  return "ã•ãã¡ã‚ƒã‚“";
  if (id === "kaede") return "ã‹ãˆã§ã¡ã‚ƒã‚“";
  if (id === "mea")   return "ã‚ã‚ã¡ã‚ƒã‚“";
  if (id === "oto")   return "ãŠã¨ã¡ã‚ƒã‚“";
  if (id === "maru")  return "ã¾ã‚‹ã¡ã‚ƒã‚“";
  return id || "ãªã¾ãˆæœªè¨­å®š";
}

		// ãƒ˜ãƒƒãƒ€ãƒ¼ã®åå‰ï¼ˆã¨ã‚Šã‚ãˆãš cast ã‚’ãã®ã¾ã¾è¡¨ç¤ºã€å¿…è¦ãªã‚‰ displayNameé€£æºã‚‚ã‚ã¨ã§ï¼‰
		document.getElementById("castName").textContent =
  castDisplayName(cast) + " ã®æ—¥è¨˜";


		// mood ãƒœã‚¿ãƒ³
		let currentMood = "";
		const moodRow = document.getElementById("moodRow");
		moodRow.addEventListener("click", (e) => {
			const btn = e.target.closest(".mood-btn");
			if (!btn) return;
			currentMood = btn.dataset.mood || "";
			// è¦‹ãŸç›®åˆ‡ã‚Šæ›¿ãˆ
			document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("active"));
			btn.classList.add("active");
		});

		// æ—¥è¨˜é€ä¿¡
		document.getElementById("sendBtn").addEventListener("click", async () => {
			const text = document.getElementById("entryText").value.trim();
			if (!text) {
				alert("ãªã‚“ã‹ã²ã¨ã“ã¨æ›¸ã„ã¦ã‹ã‚‰é€ã£ã¦ã­ï¼");
				return;
			}

			try {
				const res = await fetch(API_URL + "?mode=journal_add", {
					method: "POST",
					// â† headers ãªã—ï¼
					body: JSON.stringify({
						cast: cast,
						mood: currentMood,
						text: text
					})
				});

				const json = await res.json();
				console.log("journal_add result:", json);
				if (json.status === "ok") {
					document.getElementById("entryText").value = "";
					document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("active"));
					currentMood = "";
					await loadEntries();
					alert("é€ä¿¡ã—ãŸã‚ˆï¼åº—é•·ãŒã‚ã¨ã§èª­ã‚€ã­ğŸ“–");
				} else {
					alert("é€ä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸâ€¦åº—é•·ã«ã‚¹ã‚¯ã‚·ãƒ§é€ã£ã¦ï¼(Â´;Ï‰;ï½€)");
					console.error(json);
				}
			} catch (err) {
				console.error(err);
				alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§é€ã‚Œã¾ã›ã‚“ã§ã—ãŸâ€¦é›»æ³¢ã¨ã‹ç¢ºèªã—ã¦ã¿ã¦ï¼");
			}
		});

		// æ—¥è¨˜ä¸€è¦§èª­ã¿è¾¼ã¿
		async function loadEntries() {
			const listEl = document.getElementById("entryList");
			listEl.innerHTML = "èª­ã¿è¾¼ã¿ä¸­â€¦";

			try {
				const res = await fetch(API_URL + "?mode=journal_list&cast=" + encodeURIComponent(cast));
				const json = await res.json();
				console.log("journal_list:", json);

				if (json.status !== "ok") {
					listEl.innerHTML = "<div class='entry-empty'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦</div>";
					return;
				}

				const list = json.data || [];
				if (!list.length) {
					listEl.innerHTML = "<div class='entry-empty'>ã¾ã æ—¥è¨˜ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯1é€šã‚ã‚’æ›¸ã„ã¦ã¿ã‚ˆã£ã‹ğŸ““</div>";
					return;
				}

				listEl.innerHTML = "";

				// 1) æœˆã”ã¨ã«ã¾ã¨ã‚ã‚‹ï¼ˆyyyy-MMï¼‰
				const groups = {};
				list.forEach(item => {
					const d = item.entryDate || item.createdAt || "";
					const ym = (d && d.length >= 7) ? d.slice(0,7) : "ä¸æ˜";
					if (!groups[ym]) groups[ym] = [];
					groups[ym].push(item);
				});
				// 2) æœˆã®ä¸¦ã³é †ï¼ˆæ–°ã—ã„æœˆãŒä¸Šï¼‰
				const months = Object.keys(groups).sort((a,b) => b.localeCompare(a, "ja"));

				// 3) æç”»
				months.forEach((ym, idx) => {
					const wrap = document.createElement("div");
					wrap.className = "month-group";

					// æœ€åˆã®æœˆã ã‘é–‹ã„ã¨ãï¼ˆå¥½ã¿ã§ï¼‰
					if (idx === 0) wrap.classList.add("open");

					const monthLabel = (ym === "ä¸æ˜")
						? "æ—¥ä»˜ä¸æ˜"
						: `${ym.slice(0,4)}å¹´${ym.slice(5,7)}æœˆ`;

					const header = document.createElement("div");
					header.className = "month-header";
					header.innerHTML = `
						<div>${monthLabel}</div>
						<div class="month-meta">${groups[ym].length}ä»¶ <span class="month-chevron">â–¼</span></div>
					`;

					const body = document.createElement("div");
					body.className = "month-body";

					// æœˆã®ä¸­èº«ï¼ˆæ—¥è¨˜ã‚«ãƒ¼ãƒ‰ï¼‰ã‚’ä»Šã®ä½œã‚Šæ–¹ã§å…¥ã‚Œã‚‹
					groups[ym].forEach(item => {
						const div = document.createElement("div");
						div.className = "entry-item";

						const dateText = item.entryDate || item.createdAt || "";
						const moodText = item.mood || "";

						const h = document.createElement("div");
						h.className = "entry-header";
						h.innerHTML = `
							<div class="entry-date">${dateText}</div>
							<div class="entry-mood">${moodText}</div>
						`;

						const text = document.createElement("div");
						text.className = "entry-text";
						text.textContent = item.text || "";

						div.appendChild(h);
						div.appendChild(text);

						if (item.reply) {
							const label = document.createElement("div");
							label.className = "entry-reply-label";
							label.textContent = "åº—é•·ã‹ã‚‰ã®ã²ã¨ã“ã¨";

							const reply = document.createElement("div");
							reply.className = "entry-reply";
							reply.textContent = item.reply;

							div.appendChild(label);
							div.appendChild(reply);
						}

						const status = document.createElement("div");
						status.className = "entry-status";
						if (item.status === "replied" && item.replyAt) {
							status.textContent = "âœ… åº—é•·ãŒèª­ã‚“ã§ãã‚ŒãŸã‚ˆï¼ˆ" + item.replyAt + "ï¼‰";
						} else {
							status.textContent = "â³ åº—é•·ãŒèª­ã‚€ã®ã‚’å¾…ã£ã¦ã‚‹ã‚ˆâ€¦";
						}
						div.appendChild(status);
						body.appendChild(div);
					});

					// 4) ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰
					header.addEventListener("click", () => {
						wrap.classList.toggle("open");
					});

					wrap.appendChild(header);
					wrap.appendChild(body);
					listEl.appendChild(wrap);
				});

			} catch (err) {
				console.error(err);
				listEl.innerHTML = "<div class='entry-empty'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦</div>";
			}
		}

		// èµ·å‹•
		window.addEventListener("DOMContentLoaded", () => {
			if (cast) {
				loadEntries();
			}
		});
	</script>
</body>
</html>
