<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>åº—é•·ã¨ã®äº¤æ›æ—¥è¨˜ğŸ““</title>
	<link rel="icon" href="ã‚¢ã‚¤ã‚³ãƒ³.png" type="image/png">
	<link rel="stylesheet" href="assets/common.css">
	<link rel="stylesheet" href="assets/journal.css">
</head>

<body>
	<div class="app-shell">

		<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
		<header class="header-card">
			<div class="header-title">åº—é•·ã¨ã®äº¤æ›æ—¥è¨˜</div>
			<div class="header-sub">ã€Œä»Šæ—¥ã©ã†ã ã£ãŸï¼Ÿã€ã‚’ã“ã£ãã‚Šæ•™ãˆã¦ã­ğŸ«¶</div>
			<div class="cast-pill">
				<div class="cast-pill-inner">
					ğŸ’Œ<span id="castName">[ãªã¾ãˆ]ã®æ—¥è¨˜</span>
				</div>
			</div>
		</header>

		<!-- æ–°è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼ -->
		<section class="card">
			<div class="card-title">ä»Šæ—¥ã®ãã‚‚ã¡</div>
			<div class="mood-row" id="moodRow">
				<button type="button" class="mood-btn" data-mood="ğŸ˜Š">ğŸ˜Š ãŸã®ã—ã„</button>
				<button type="button" class="mood-btn" data-mood="ğŸ˜">ğŸ˜ ãµã¤ã†</button>
				<button type="button" class="mood-btn" data-mood="ğŸ˜­">ğŸ˜­ ã—ã‚“ã©ã„</button>
				<button type="button" class="mood-btn" data-mood="ğŸ”¥">ğŸ”¥ ãŒã‚“ã°ã‚ŠãŸã„</button>
				<button type="button" class="mood-btn" data-mood="ğŸ¥¹">ğŸ¥¹ ãã„ã¦ã»ã—ã„</button>
			</div>
			<textarea id="entryText" placeholder="ãã‚‡ã†ã®å‡ºå‹¤ã§ã‚ã£ãŸã“ã¨ãƒ»ã†ã‚Œã—ã‹ã£ãŸã“ã¨ãƒ»ãƒ¢ãƒ¤ã£ã¨ã—ãŸã“ã¨ãªã©ã€ãªã‚“ã§ã‚‚æ›¸ã„ã¦OKã ã‚ˆğŸ¾"></textarea>
				<div class="send-row">
					<button class="btn-send" id="sendBtn">åº—é•·ã«é€ã‚‹ğŸ“¨</button>
				</div>
		</section>

		<!-- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸€è¦§ -->

		<div class="list-title">ã“ã‚Œã¾ã§ã®æ—¥è¨˜</div>
		<div id="entryList"></div>
		<div class="footer-nav">
			<a class="back-link" id="backLink" href="#">â† é€²æ—ãƒšãƒ¼ã‚¸ã«ã‚‚ã©ã‚‹</a>
		</div>
	</div>

<script>
	// â˜…ã“ã“ã‚’ã‚¹ãƒ¼ãƒ‘ãƒ¼APIã®URLã«ç½®ãæ›ãˆ
	const API_URL = "https://script.google.com/macros/s/AKfycbwZy842pl9a5bsSFH1trXhW7-hIByswRWAguxwgeCsf-8Ujw2MRFJ7N7cypExhmehlR/exec";

	const params = new URLSearchParams(location.search);
	const cast   = params.get("cast") || "";

	if (!cast) {
		alert("ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ ?cast=â—¯â—¯ ã‚’ä»˜ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã­ï¼ï¼ˆä¾‹: journal.html?cast=sakiï¼‰");
	}

	// æˆ»ã‚‹ãƒªãƒ³ã‚¯
	const back = document.getElementById("backLink");
	if (back) {
		if (cast) {
			back.setAttribute("href", "view.html?cast=" + encodeURIComponent(cast));
		} else {
			back.setAttribute("href", "view.html");
		}
	}

	// âœ… progress ã‹ã‚‰ displayName ã‚’å–ã£ã¦ãã‚‹
	async function fetchCastDisplayName(castId) {
		if (!castId) return "ãªã¾ãˆæœªè¨­å®š";
		try {
			const res  = await fetch(API_URL + "?mode=progress&cast=" + encodeURIComponent(castId));
			const json = await res.json();
			if (json && json.status === "ok" && json.data) {
				return json.data.displayName || json.data.name || castId;
			}
		} catch (e) {
			console.warn("fetchCastDisplayName failed:", e);
		}
		return castId;
	}

	// mood ãƒœã‚¿ãƒ³
	let currentMood = "";
	const moodRow = document.getElementById("moodRow");
	if (moodRow) {
		moodRow.addEventListener("click", (e) => {
			const btn = e.target.closest(".mood-btn");
			if (!btn) return;
			currentMood = btn.dataset.mood || "";
			document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("active"));
			btn.classList.add("active");
		});
	}

	// æ—¥è¨˜é€ä¿¡
	const sendBtn = document.getElementById("sendBtn");
	if (sendBtn) {
		sendBtn.addEventListener("click", async () => {
			const textEl = document.getElementById("entryText");
			const text = (textEl ? textEl.value : "").trim();
			if (!text) {
				alert("ãªã‚“ã‹ã²ã¨ã“ã¨æ›¸ã„ã¦ã‹ã‚‰é€ã£ã¦ã­ï¼");
				return;
			}

			try {
				const res = await fetch(API_URL + "?mode=journal_add", {
					method: "POST",
					body: JSON.stringify({
						cast: cast,
						mood: currentMood,
						text: text
					})
				});

				const json = await res.json();
				console.log("journal_add result:", json);
				if (json.status === "ok") {
					if (textEl) textEl.value = "";
					document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("active"));
					currentMood = "";
					await loadEntries();
					alert("é€ä¿¡ã—ãŸã‚ˆï¼åº—é•·ãŒã‚ã¨ã§èª­ã‚€ã­ğŸ“–");
				} else {
					alert("é€ä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸâ€¦åº—é•·ã«ã‚¹ã‚¯ã‚·ãƒ§é€ã£ã¦ï¼(Â´;Ï‰;ï½€)");
					console.error(json);
				}
			} catch (err) {
				console.error(err);
				alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§é€ã‚Œã¾ã›ã‚“ã§ã—ãŸâ€¦é›»æ³¢ã¨ã‹ç¢ºèªã—ã¦ã¿ã¦ï¼");
			}
		});
	}

	// âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åˆ¶å¾¡ï¼šé–‹ã„ãŸæœˆä»¥å¤–ã¯é–‰ã˜ã‚‹
	function openOnlyThisMonth(targetWrap) {
		document.querySelectorAll(".month-group.open").forEach(el => {
			if (el !== targetWrap) el.classList.remove("open");
		});
		targetWrap.classList.add("open");
	}

	// æ—¥è¨˜ä¸€è¦§èª­ã¿è¾¼ã¿
	async function loadEntries() {
		const listEl = document.getElementById("entryList");
		if (!listEl) return;

		listEl.innerHTML = "èª­ã¿è¾¼ã¿ä¸­â€¦";

		try {
			const res = await fetch(API_URL + "?mode=journal_list&cast=" + encodeURIComponent(cast));
			const json = await res.json();
			console.log("journal_list:", json);

			if (json.status !== "ok") {
				listEl.innerHTML = "<div class='entry-empty'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦</div>";
				return;
			}

			const list = json.data || [];
			if (!list.length) {
				listEl.innerHTML = "<div class='entry-empty'>ã¾ã æ—¥è¨˜ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯1é€šã‚ã‚’æ›¸ã„ã¦ã¿ã‚ˆã£ã‹ğŸ““</div>";
				return;
			}

			listEl.innerHTML = "";

			// 1) æœˆã”ã¨ã«ã¾ã¨ã‚ã‚‹ï¼ˆyyyy-MMï¼‰
			const groups = {};
			list.forEach(item => {
				const d = item.entryDate || item.createdAt || "";
				const ym = (d && d.length >= 7) ? d.slice(0,7) : "ä¸æ˜";
				if (!groups[ym]) groups[ym] = [];
				groups[ym].push(item);
			});

			// 2) æœˆã®ä¸¦ã³é †ï¼ˆæ–°ã—ã„æœˆãŒä¸Šï¼‰
			const months = Object.keys(groups).sort((a,b) => b.localeCompare(a, "ja"));

			// 3) æç”»
			months.forEach((ym, idx) => {
				const wrap = document.createElement("div");
				wrap.className = "month-group";

				// æœ€åˆã®æœˆã ã‘é–‹ã„ã¦ãŠã
				if (idx === 0) wrap.classList.add("open");

				const monthLabel = (ym === "ä¸æ˜")
					? "æ—¥ä»˜ä¸æ˜"
					: `${ym.slice(0,4)}å¹´${ym.slice(5,7)}æœˆ`;

				const header = document.createElement("div");
				header.className = "month-header";
				header.innerHTML = `
					<div>${monthLabel}</div>
					<div class="month-meta">${groups[ym].length}ä»¶ <span class="month-chevron">â–¼</span></div>
				`;

				const body = document.createElement("div");
				body.className = "month-body";

				// æ—¥è¨˜ã‚«ãƒ¼ãƒ‰
				groups[ym].forEach(item => {
					const div = document.createElement("div");
					div.className = "entry-item";

					const dateText = item.entryDate || item.createdAt || "";
					const moodText = item.mood || "";

					const h = document.createElement("div");
					h.className = "entry-header";
					h.innerHTML = `
						<div class="entry-date">${dateText}</div>
						<div class="entry-mood">${moodText}</div>
					`;

					const text = document.createElement("div");
					text.className = "entry-text";
					text.textContent = item.text || "";

					div.appendChild(h);
					div.appendChild(text);

					if (item.reply) {
						const label = document.createElement("div");
						label.className = "entry-reply-label";
						label.textContent = "åº—é•·ã‹ã‚‰ã®ã²ã¨ã“ã¨";

						const reply = document.createElement("div");
						reply.className = "entry-reply";
						reply.textContent = item.reply;

						div.appendChild(label);
						div.appendChild(reply);
					}

					const status = document.createElement("div");
					status.className = "entry-status";
					if (item.status === "replied" && item.replyAt) {
						status.textContent = "âœ… åº—é•·ãŒèª­ã‚“ã§ãã‚ŒãŸã‚ˆï¼ˆ" + item.replyAt + "ï¼‰";
					} else {
						status.textContent = "â³ åº—é•·ãŒèª­ã‚€ã®ã‚’å¾…ã£ã¦ã‚‹ã‚ˆâ€¦";
					}
					div.appendChild(status);

					body.appendChild(div);
				});

				// ã‚¯ãƒªãƒƒã‚¯ã§ã€Œã“ã‚Œã ã‘é–‹ãã€
				header.addEventListener("click", () => {
					const isOpen = wrap.classList.contains("open");
					if (isOpen) {
						wrap.classList.remove("open"); // ã‚‚ã†ä¸€å›æŠ¼ã—ãŸã‚‰é–‰ã˜ã‚‹
					} else {
						openOnlyThisMonth(wrap); // é–‹ã„ãŸã‚‰ä»–ã¯é–‰ã˜ã‚‹
					}
				});

				wrap.appendChild(header);
				wrap.appendChild(body);
				listEl.appendChild(wrap);
			});

		} catch (err) {
			console.error(err);
			listEl.innerHTML = "<div class='entry-empty'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦</div>";
		}
	}

	// èµ·å‹•
	window.addEventListener("DOMContentLoaded", async () => {
		if (!cast) return;

		// âœ… ãƒ˜ãƒƒãƒ€ãƒ¼åã‚’ displayName ã«ã™ã‚‹
		const nameToShow = await fetchCastDisplayName(cast);
		const castNameEl = document.getElementById("castName");
		if (castNameEl) castNameEl.textContent = nameToShow + " ã®æ—¥è¨˜";

		// âœ… æ—¥è¨˜èª­ã¿è¾¼ã¿
		loadEntries();
	});
</script>

</body>
</html>
