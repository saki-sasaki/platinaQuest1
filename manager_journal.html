<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>åº—é•·â˜…äº¤æ›æ—¥è¨˜ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
	<link rel="stylesheet" href="assets/common.css">
	<link rel="stylesheet" href="assets/manager_journal.css" />
</head>

<body>
	<div class="app-shell">

		<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
		<header class="header-card">
			<div class="header-top">
				<div class="header-title">
					ğŸ““ åº—é•·ç”¨ãƒ»äº¤æ›æ—¥è¨˜ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
				</div>
			</div>

			<div class="header-filters">
				<div>
					<label for="castFilter">ã‚­ãƒ£ã‚¹ãƒˆ</label>
					<select id="castFilter">
						<option value="">å…¨ã‚­ãƒ£ã‚¹ãƒˆ</option>
					</select>
				</div>
				<div>
					<label for="statusFilter">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
					<select id="statusFilter">
						<option value="">å…¨éƒ¨</option>
						<option value="new">æœªè¿”ä¿¡ã ã‘</option>
						<option value="replied">è¿”ä¿¡æ¸ˆã¿ã ã‘</option>
					</select>
				</div>
			</div>
		</header>

		<div class="main-grid">
			<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒ—ãƒ­ãƒ•å¸³ã¨æƒãˆãŸç‰ˆï¼‰ -->
			<section class="calendar-card">
				<div class="calendar-header">
					<button class="cal-nav" id="calPrevBtn">â—€</button>
					<div class="calendar-title" id="calTitle">2025å¹´1æœˆ</div>
					<button class="cal-nav" id="calNextBtn">â–¶</button>
				</div>

				<!-- æ›œæ—¥ï¼‹æ—¥ä»˜ã®ã‚°ãƒªãƒƒãƒ‰ -->
				<div class="calendar-grid" id="calendarGrid">
				<!-- JSã§åŸ‹ã‚ã‚‹ -->
				</div>

				<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª¬æ˜ -->
				<div id="calendarInfo" class="calendar-detail">
					æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®æ—¥ã®äº¤æ›æ—¥è¨˜ãŒä¸‹ã«å‡ºã‚‹ã‚ˆğŸ““
				</div>
			</section>

			<!-- æ—¥è¨˜ãƒªã‚¹ãƒˆ -->
			<section class="card">
				<div id="dayTitle" class="day-title">
					æ—¥ä»˜ã‚’é¸ã‚“ã§ã­ğŸ“…
				</div>
				<div id="entryList" class="entry-list">
					<div class="entry-empty">
						ã¾ã æ—¥ä»˜ãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
					</div>
				</div>
			</section>

			<!-- åº—é•·ãƒªãƒ—ãƒ©ã‚¤å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰ -->
			<div id="replyPanel" class="reply-panel">
				<div class="reply-inner">
					<div class="reply-header">
						<div class="reply-title">åº—é•·ãƒªãƒ—ãƒ©ã‚¤ğŸ’Œ</div>
						<button type="button" id="btnReplyClose" class="reply-close">Ã—</button>
					</div>

					<div class="reply-target" id="replyTargetInfo">
						ï¼ˆã ã‚Œã®æ—¥è¨˜ã«è¿”ä¿¡ä¸­ã‹ã“ã“ã«å‡ºã‚‹ï¼‰
					</div>

					<div class="reply-bubble">
						<div class="reply-avatar">åº—</div>
						<div class="reply-bubble-body">
							<textarea
								id="replyInput"
								rows="3"
								placeholder="ã²ã¨ã“ã¨ã§ã‚‚OKğŸ«¶ ã€ä»Šæ—¥ã‚‚æ¥ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã€ã¨ã‹é€ã£ã¦ã¿ã‚ˆã€œ"
							></textarea>
						</div>
					</div>

					<button id="btnReplySend" class="btn-reply-send">
						ã“ã®å†…å®¹ã§é€ã‚‹ğŸ’«
					</button>
				</div>
			</div>
		</div>

		<div class="footer-nav">
			<a id="backLink" class="back-link" href="manager_dashboard.html">
				â† åº—é•·ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚‚ã©ã‚‹
			</a>
		</div>
	</div>

	<script>
		// â˜…ã“ã“ã‚’ã‚¹ãƒ¼ãƒ‘ãƒ¼APIã®URLã«
		const API_URL = "https://script.google.com/macros/s/AKfycbwZy842pl9a5bsSFH1trXhW7-hIByswRWAguxwgeCsf-8Ujw2MRFJ7N7cypExhmehlR/exec";

		let allEntries = [];
		let currentYear;
		let currentMonth;
		let selectedDate = "";

		const castFilterEl   = document.getElementById("castFilter");
		const statusFilterEl = document.getElementById("statusFilter");
		const calendarGrid   = document.getElementById("calendarGrid");
		const calTitle       = document.getElementById("calTitle");
		const calendarInfo   = document.getElementById("calendarInfo");
		const dayTitle       = document.getElementById("dayTitle");
		const entryListEl    = document.getElementById("entryList");

		function formatYmd(y,m,d){
			const mm = ("0"+m).slice(-2);
			const dd = ("0"+d).slice(-2);
			return y + "-" + mm + "-" + dd;
		}

		function castDisplayName(id){
  if (id === "saki")  return "ã•ãã¡ã‚ƒã‚“";
  if (id === "kaede") return "ã‹ãˆã§ã¡ã‚ƒã‚“";
  if (id === "mea")   return "ã‚ã‚ã¡ã‚ƒã‚“";
  if (id === "oto")   return "ãŠã¨ã¡ã‚ƒã‚“";
  if (id === "maru")  return "ã¾ã‚‹ã¡ã‚ƒã‚“";
  return id || "ãªã¾ãˆæœªè¨­å®š";
}

		function buildCastFilter() {
			const set = new Set();
			allEntries.forEach(e => {
				if (e.cast) set.add(e.cast);
			});
			castFilterEl.innerHTML = '<option value="">å…¨ã‚­ãƒ£ã‚¹ãƒˆ</option>';
			Array.from(set).sort().forEach(c => {
				const opt = document.createElement("option");
				opt.value = c;
				opt.textContent = castDisplayName(c);
				castFilterEl.appendChild(opt);
			});
		}

		function getEntriesForDate(dateStr) {
			const castFilter   = castFilterEl.value;
			const statusFilter = statusFilterEl.value;
			return allEntries.filter(e => {
				if (e.entryDate !== dateStr) return false;
				if (castFilter && e.cast !== castFilter) return false;
				if (statusFilter === "new" && e.status === "replied") return false;
				if (statusFilter === "replied" && e.status !== "replied") return false;
				return true;
			});
		}

		function renderCalendar() {
			// ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ2025å¹´12æœˆï¼‰
			calTitle.textContent = `${currentYear}å¹´ ${currentMonth}æœˆ`;

			// ä¸­èº«ã‚¯ãƒªã‚¢
			calendarGrid.innerHTML = "";

			// å¿µã®ãŸã‚ã“ã“ã§ã‚°ãƒªãƒƒãƒ‰æŒ‡å®šï¼ˆCSSãŒå£Šã‚Œã¦ã¦ã‚‚ä¿é™ºã«ãªã‚‹ï¼‰
			calendarGrid.style.display = "grid";
			calendarGrid.style.gridTemplateColumns = "repeat(7, 1fr)";
			calendarGrid.style.gap = ".25rem";

			// 1è¡Œç›®ï¼šæ›œæ—¥
			const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
			weekdays.forEach(w => {
				const wEl = document.createElement("div");
				wEl.className = "cal-weekday";
				wEl.textContent = w;
				calendarGrid.appendChild(wEl);
			});

			// æ—¥ä»˜è¨ˆç®—
			const first    = new Date(currentYear, currentMonth - 1, 1);
			const startDay = first.getDay();                  // 0(æ—¥)ã€œ6(åœŸ)
			const lastDate = new Date(currentYear, currentMonth, 0).getDate();

			let cellIndex = 0;

			// å…ˆé ­ã®ç©ºç™½ï¼ˆå‰æœˆã¶ã‚“ï¼‰
			for (let i = 0; i < startDay; i++) {
				const empty = document.createElement("div");
				empty.className = "calendar-day empty";
				calendarGrid.appendChild(empty);
				cellIndex++;
			}

			// ä»Šæ—¥åˆ¤å®šç”¨
			const today = new Date();
			const todayStr = formatYmd(
				today.getFullYear(),
				today.getMonth() + 1,
				today.getDate()
			);

			// æ—¥ä»˜ã‚»ãƒ«
			for (let d = 1; d <= lastDate; d++) {
				const dateStr = formatYmd(currentYear, currentMonth, d);

				const dayEl = document.createElement("div");
				dayEl.className = "calendar-day";
				dayEl.dataset.date = dateStr;

				// ä»Šæ—¥ãƒã‚¤ãƒ©ã‚¤ãƒˆ
				if (dateStr === todayStr) {
					dayEl.classList.add("today");
				}

				// é¸æŠä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ
				if (selectedDate === dateStr) {
					dayEl.classList.add("selected");
				}

				// æ—¥ä»˜æ•°å­—
				const numEl = document.createElement("div");
				numEl.className = "calendar-day-num";
				numEl.textContent = d;
				dayEl.appendChild(numEl);

				// ä»¶æ•°ãƒãƒƒã‚¸
				const count = getEntriesForDate(dateStr).length;
				if (count > 0) {
					const badge = document.createElement("div");
					badge.className = "calendar-day-badge";
					badge.textContent = count + "ä»¶";
					dayEl.appendChild(badge);
				}

				// ã‚¯ãƒªãƒƒã‚¯ã§ãã®æ—¥ã®æ—¥è¨˜ã‚’è¡¨ç¤º
				dayEl.addEventListener("click", () => {
					selectedDate = dateStr;
					renderCalendar();   // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
					renderDayEntries(); // ä¸‹ã®ãƒªã‚¹ãƒˆæ›´æ–°
				});

				calendarGrid.appendChild(dayEl);
				cellIndex++;
			}

			// æœ€å¾Œã®è¡Œã®ä½™ã‚Šã‚»ãƒ«ã‚’ç©ºç™½ã§åŸ‹ã‚ã‚‹
			const totalCells = Math.ceil(cellIndex / 7) * 7;
			for (let i = cellIndex; i < totalCells; i++) {
				const empty = document.createElement("div");
				empty.className = "calendar-day empty";
				calendarGrid.appendChild(empty);
			}

			// â˜… é¸æŠä¸­ã®æ—¥ä»˜ã‚»ãƒ«ã«ã‚­ãƒ©ãƒƒæ¼”å‡ºã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã‚‹
function highlightSelectedCell() {
  if (!selectedDate) return;

  const cells = document.querySelectorAll("[data-date]");
  cells.forEach(cell => {
    if (cell.dataset.date === selectedDate) {
      cell.classList.add("is-selected");
    } else {
      cell.classList.remove("is-selected");
    }
  });
}
			highlightSelectedCell();
		}


		// ===== åº—é•·ãƒªãƒ—ãƒ©ã‚¤å°‚ç”¨ãƒ•ã‚©ãƒ¼ãƒ  =====
		const replyPanel      = document.getElementById("replyPanel");
		const replyInput      = document.getElementById("replyInput");
		const replyTargetInfo = document.getElementById("replyTargetInfo");
		const btnReplySend    = document.getElementById("btnReplySend");
		const btnReplyClose   = document.getElementById("btnReplyClose");

		let currentReplyId = null;

		function openReplyForm(item) {
			currentReplyId = item.id;
			replyTargetInfo.textContent =
			(item.entryDate || item.createdAt || "") + " ï¼ " + (item.cast || "") + " ã®æ—¥è¨˜ã«è¿”ä¿¡";

			replyInput.value = item.reply || "";
			replyPanel.classList.add("is-open");
			replyInput.focus();
		}

		function closeReplyForm() {
			replyPanel.classList.remove("is-open");
			replyInput.value = "";
			replyTargetInfo.textContent = "";
			currentReplyId = null;
		}

		btnReplyClose.addEventListener("click", () => {
			closeReplyForm();
		});

		btnReplySend.addEventListener("click", async () => {
			const text = replyInput.value.trim();
			if (!text) {
				alert("ãªã«ã‹å…¥åŠ›ã—ã¦ã­ï¼");
				return;
			}
			if (!currentReplyId) {
			console.warn("currentReplyId ãŒæœªè¨­å®šã®ã¾ã¾é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ˆ");
		return;
	  }

	  try {
		const res = await fetch(API_URL + "?mode=journal_reply", {
		  method: "POST",
		  body: JSON.stringify({
			id:    currentReplyId,
			reply: text
		  })
		});
		const json = await res.json();
		console.log("journal_reply:", json);

		if (json.status === "ok") {
		  await reloadEntriesKeepDate();
		  closeReplyForm();
		  alert("ãƒªãƒ—ãƒ©ã‚¤ã‚’é€ä¿¡ã—ãŸã‚ˆâœ¨");
		} else {
		  alert("æ›´æ–°ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸâ€¦");
		}
	  } catch (err) {
		console.error(err);
		alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ");
	  }
	});

	function renderDayEntries() {
	  if (!selectedDate) {
		dayTitle.textContent = "æ—¥ä»˜ã‚’é¸ã‚“ã§ã­ğŸ“…";
		entryListEl.innerHTML = '<div class="entry-empty">ã¾ã æ—¥ä»˜ãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
		return;
	  }

	  const list = getEntriesForDate(selectedDate);
	  dayTitle.textContent = selectedDate + " ã®äº¤æ›æ—¥è¨˜";
	  calendarInfo.textContent = "";

	  if (!list.length) {
		entryListEl.innerHTML = '<div class="entry-empty">ã“ã®æ—¥ã¯ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
		return;
	  }

	  entryListEl.innerHTML = "";
	  list.forEach(item => {
		const div = document.createElement("div");
		div.className = "entry-item";

		const headerRow = document.createElement("div");
		headerRow.className = "entry-header-row";

		const left = document.createElement("div");
		left.innerHTML = `
		  <div class="entry-cast">${castDisplayName(item.cast) || "(castä¸æ˜)"}</div>
		  <div class="entry-date">${item.createdAt || ""}</div>
		`;

		const mood = document.createElement("div");
		mood.className = "entry-mood";
		mood.textContent = item.mood || "moodãªã—";

		headerRow.appendChild(left);
		headerRow.appendChild(mood);

		const text = document.createElement("div");
		text.className = "entry-text";
		text.textContent = item.text || "";

		div.appendChild(headerRow);
		div.appendChild(text);

		if (item.reply) {
		  const replyBlock = document.createElement("div");
		  replyBlock.className = "entry-reply-block";

		  const label = document.createElement("div");
		  label.className = "entry-reply-label";
		  label.innerHTML = `
			<span class="entry-reply-label-badge">åº—é•·</span>
			<span>åº—é•·ã‹ã‚‰ã®ã²ã¨ã“ã¨</span>
		  `;

		  const bubble = document.createElement("div");
		  bubble.className = "entry-reply-bubble";
		  bubble.textContent = item.reply;

		  replyBlock.appendChild(label);
		  replyBlock.appendChild(bubble);
		  div.appendChild(replyBlock);
		}

		const status = document.createElement("div");
		status.className = "entry-status";
		if (item.status === "replied" && item.replyAt) {
		  status.textContent = "âœ… åº—é•·è¿”ä¿¡æ¸ˆã¿ï¼ˆ" + item.replyAt + "ï¼‰";
		  status.classList.add("replied");
		} else {
		  status.textContent = "â³ æœªè¿”ä¿¡";
		}
		div.appendChild(status);

		const actions = document.createElement("div");
		actions.className = "entry-actions";

		const replyBtn = document.createElement("button");
		replyBtn.className = "btn-sm reply";
		replyBtn.textContent = "è¿”ä¿¡ã‚’æ›¸ã";
		replyBtn.addEventListener("click", () => {
		  openReplyForm(item);
		});

		const btnDelete = document.createElement("button");
		btnDelete.className = "btn-sm delete";
		btnDelete.textContent = "å‰Šé™¤";
		btnDelete.addEventListener("click", async () => {
		  if (!confirm("ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¦ã‚‚ã„ã„ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ãªã„ã‚ˆï¼‰")) return;
		  try {
			const res = await fetch(API_URL + "?mode=journal_delete", {
			  method: "POST",
			  body: JSON.stringify({ id: item.id })
			});
			const json = await res.json();
			console.log("journal_delete:", json);
			if (json.status === "ok") {
			  await reloadEntriesKeepDate();
			  alert("å‰Šé™¤ã—ã¾ã—ãŸğŸ—‘");
			} else {
			  alert("å‰Šé™¤ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸâ€¦");
			}
		  } catch (err) {
			console.error(err);
			alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ");
		  }
		});

		actions.appendChild(replyBtn);
		actions.appendChild(btnDelete);

		div.appendChild(actions);

		entryListEl.appendChild(div);
	  });
	}

	async function loadAllEntries() {
	  entryListEl.innerHTML = '<div class="entry-empty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
	  try {
		const res = await fetch(API_URL + "?mode=journal_list");
		const json = await res.json();
		console.log("journal_list(manager):", json);
		if (json.status !== "ok") {
		  entryListEl.innerHTML = '<div class="entry-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦</div>';
		  return;
		}
		allEntries = json.data || [];
		buildCastFilter();
	  } catch (err) {
		console.error(err);
		entryListEl.innerHTML = '<div class="entry-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦</div>';
	  }
	}

	async function reloadEntriesKeepDate() {
	  await loadAllEntries();
	  renderCalendar();
	  renderDayEntries();
	}

document.getElementById("calPrevBtn").addEventListener("click", () => {
  currentMonth--;
  if (currentMonth <= 0) {
	currentMonth = 12;
	currentYear--;
  }
  renderCalendar();
  renderDayEntries();
});

document.getElementById("calNextBtn").addEventListener("click", () => {
  currentMonth++;
  if (currentMonth >= 13) {
	currentMonth = 1;
	currentYear++;
  }
  renderCalendar();
  renderDayEntries();
});

	castFilterEl.addEventListener("change", () => {
	  renderCalendar();
	  renderDayEntries();
	});
	statusFilterEl.addEventListener("change", () => {
	  renderCalendar();
	  renderDayEntries();
	});

	window.addEventListener("DOMContentLoaded", async () => {
	  const today = new Date();
	  currentYear  = today.getFullYear();
	  currentMonth = today.getMonth() + 1;
	  await loadAllEntries();
	  renderCalendar();
	  renderDayEntries();
	});
  </script>
</body>
</html>
